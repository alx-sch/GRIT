generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {


  // Primary Key
  id                     Int         @id @default(autoincrement())

  // Core Data
  email                  String      @unique
  password               String?
  name                   String
  avatarKey              String?
  confirmationToken      String?     @unique
  googleId               String?

  // Status Flags
  isConfirmed            Boolean     @default(false)

  // Relations
  events                 Event[]     @relation("EventAuthor")
  locations              Location[]
  chatMessages           ChatMessage[]
  convMemberships        ConversationParticipant[]
  convCreated            Conversation[]
  attending              EventAttendee[]
  sentFriendRequests     FriendRequest[] @relation("requester")
  receivedFriendRequests FriendRequest[] @relation("receiver")
  friendsAsUserA         Friends[]       @relation("FriendUserA")
  friendsAsUserB         Friends[]       @relation("FriendUserB")

  // Time Stamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime     @updatedAt
}

model Location {
  // Primary Key
  id          Int         @id @default(autoincrement())

  // Core data
  name        String
  address	    String?
  city        String?
  country     String?
  postalCode  String?
  longitude   Float
  latitude    Float

  // Status Flags
  isPublic    Boolean     @default(false)

  // Foreign Keys
  authorId    Int?

  // Relations
  author      User?        @relation(fields: [authorId], references: [id], onDelete: SetNull) // If author is deleted, location shows authorId NULL
  events      Event[]

  // Time Stamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Event {
  // Primary key
  id            Int       @id @default(autoincrement())

  // Core data
  content       String?
  endAt         DateTime
  imageKey      String?
  startAt       DateTime
  title         String

  // Status flags
  isPublished   Boolean   @default(false)
  isPublic      Boolean   @default(true)

  // Foreign keys
  authorId      Int?
  locationId    Int?

  // Relations
  author        User?      @relation("EventAuthor", fields: [authorId], references: [id], onDelete: SetNull) // If author is deleted, event shows authorId NULL
  location      Location?  @relation(fields: [locationId], references: [id], onDelete: SetNull) // // If location is deleted, location shows locationId NULL
  conversation  Conversation?
  attendees     EventAttendee[]

  // Time Stamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum ConversationType {
  DIRECT
  EVENT
  GROUP
}

model Conversation {
  // Primary Key
  id            String              @id @default(uuid())

  // Core Data
  type          ConversationType
  title         String?

  // Foregin Keys
  createdBy     Int?
  eventId       Int?                @unique

  // Relations
  creator       User?                @relation(fields: [createdBy], references: [id], onDelete: SetNull) // If creator is deleted, conversation shows createdBy NULL
  messages      ChatMessage[]
  event         Event?               @relation(fields: [eventId], references: [id], onDelete: Cascade) // If event is deleted, conversation is DELETED.
  participants  ConversationParticipant[]

  // Time Stamps
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

// Explicit join table to track which user is part of which conversation.
model ConversationParticipant {
  conversationId String
  userId         Int

  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade) // On delete cascade = Delete join entry when conversation is deleted
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade) // If user is deleted, ConversationParticipant is deleted.

  @@id([conversationId, userId])
  @@index([userId])
}

// Expicit join table to track event attendance
model EventAttendee {
  eventId         Int
  userId          Int

  event           Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@index([userId])
}

model ChatMessage {
  // Primary Key
  id             String       @id

  // Core Data
  conversationId String
  text           String

  // Foreign Keys
  authorId       Int?

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade) // If conversation is deleted, chat message is deleted
  author         User?         @relation(fields: [authorId], references: [id], onDelete: SetNull) // If author of chatmessage is deleted, authorId is set to NULL

  // Time Stamps
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt, id])
}

model FriendRequest {
  // Primary Key
  id          String   @id @default(uuid())

  // Foreign Keys
  requesterId Int
  receiverId  Int

  // Relations
  requester   User     @relation("requester", fields: [requesterId], references: [id], onDelete: Cascade)
  receiver    User     @relation("receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  // Time Stamps
  createdAt   DateTime @default(now())

  @@unique([requesterId, receiverId])
}

model Friends {
  // Primary Key
  id        String   @id @default(uuid())

  // Foreign Keys
  userId    Int
  friendId  Int

  // Relations
  user      User     @relation("FriendUserA", fields: [userId], references: [id], onDelete: Cascade)
  friend    User     @relation("FriendUserB", fields: [friendId], references: [id], onDelete: Cascade)

  // Time Stamps
  createdAt DateTime @default(now())

  @@unique([userId, friendId])
}
